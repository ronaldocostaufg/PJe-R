{% load static %}
<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Materiais por Validade</title>
    <link rel="stylesheet" href="{% static 'requisicaofacil/css/material_pesquisa.css' %}">
    <style>
        .table-row.expired {
            color: #dc3545; /* Cor vermelha para alerta */
            background-color: #f8d7da; /* Fundo vermelho claro */
        }
        
        .table-row.expired:hover {
            background-color: #f5c6cb; /* Fundo vermelho um pouco mais escuro no hover */
        }

        .col-cod, .col-desc, .col-dias-vencido, .col-data-vencimento {
            padding: 0 10px;
            text-align: left;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .col-cod { flex: 0 0 150px; display: flex; align-items: center; gap: 8px; }
        .col-desc { flex: 1; min-width: 200px; }
        .col-dias-vencido { flex: 0 0 180px; }
        .col-data-vencimento { flex: 0 0 180px; }

        .copy-svg { cursor: pointer; }
        
        /* ================================== */
        /* === MODAL === */
        /* ================================== */
        .modal-overlay.hidden {
        display: none;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .modal-header h3 { font-size: 20px; font-weight: 500; color: #09475C; }
        .modal-header button { background: none; border: none; cursor: pointer; padding: 5px; }
        .modal-row:nth-child(odd) { background-color: #032b2e29; }
        .modal-row > span:first-child { font-weight: bold; }
        
        .modal-row.full-width { flex-direction: column; }
        .modal-row.full-width > span:first-child { margin-bottom: 10px; }
        
        #modal-descricao {
            padding: 10px;
            width: 100%;
            height: 180px;
            resize: vertical;
            border: 1px solid #ced4da;
            border-radius: 4px;
            background-color: #fff;
        }

        .modal-row {
            background-color: #fefefeff; 
        }
    </style>
</head>

<body>

    <nav class="nav-menu-bar">
        <div class="header-container1">
            <button class="menu-toggle" aria-label="Abrir menu">
                <span class="hamburger"></span>
            </button>
            <nav class="nav">
                <ul class="nav-list">
                    <li><a href="{% url 'consultaOficial:material_pesquisa' %}">Início</a></li>
                    <li><a href="{% url 'consultaOficial:material_validade' %}">Materiais com data de vencimento</a></li>
                </ul>
            </nav>
        </div>
    </nav>

    <header class="header">
        <div class="header-container">
            <div class="logo-container">Materiais com data de vencimento</div>
        </div>
        <div class="divider"></div>
    </header>

    <div class="consulta-container">
        <form method="GET" action="" id="filter-form">
            <div class="filter-header">
                <button type="button" class="filter-btn clear-btn" id="clear-filters-btn" data-tooltip="Resetar filtros">
                    <div class="button-wrapper">
                        <div class="text">Limpar filtros</div>
                        <span class="icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13.013 3H2l8 9.46V19l4 2v-8.54l.9-1.055" /><path d="m22 3-5 5" /><path d="m17 3 5 5" /></svg>
                        </span>
                    </div>
                </button>
                <p id='mobile' class="instruction-text">Clique na linha para ver detalhes</p>
                <p class="instruction-text">Clique na linha para ver os detalhes completos<br />Clique no código para copiar</p>
                <button type="submit" class="filter-btn apply-btn" data-tooltip="Filtrar resultados">
                    <div class="button-wrapper">
                        <div class="text">Aplicar filtro</div>
                        <span class="icon">
                            <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" width="24" height="24" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M22 3H2l8 9.46V19l4 2v-8.54L22 3z" /></svg>
                        </span>
                    </div>
                </button>
            </div>

            <div class="main-filters">
                <div class="filter-group">
                    <label>Filtro de código</label>
                    <div class="search-input">
                        <span class="search-icon submit-on-click">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g stroke-width="0"></g><g stroke-linecap="round" stroke-linejoin="round"></g><g> <path d="M15.7955 15.8111L21 21M18 10.5C18 14.6421 14.6421 18 10.5 18C6.35786 18 3 14.6421 3 10.5C3 6.35786 6.35786 3 10.5 3C14.6421 3 18 6.35786 18 10.5Z" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path> </g></svg>
                        </span>
                        <input type="number" name="codigo" placeholder="Pesquisar por código..." value="{{ request.GET.codigo }}">
                    </div>
                </div>
                <div class="filter-group">
                    <label>Filtro de descrição</label>
                    <div class="search-input">
                        <span class="search-icon submit-on-click">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g stroke-width="0"></g><g stroke-linecap="round" stroke-linejoin="round"></g><g> <path d="M15.7955 15.8111L21 21M18 10.5C18 14.6421 14.6421 18 10.5 18C6.35786 18 3 14.6421 3 10.5C3 6.35786 6.35786 3 10.5 3C14.6421 3 18 6.35786 18 10.5Z" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path> </g></svg>
                        </span>
                        <input type="text" name="descricao" placeholder="Pesquisar por descrição..." value="{{ request.GET.descricao }}">
                    </div>
                </div>
                <div class="filter-group">
                    <label>Dias para vencer</label>
                    <div class="quantity-filter">
                        <select name="prazoValidade_filter">
                            <option value="menorq" {% if request.GET.prazoValidade_filter == 'menorq' %}selected{% endif %}>Menor ou igual a</option>
                            <option value="maiorq" {% if request.GET.prazoValidade_filter == 'maiorq' %}selected{% endif %}>Maior ou igual a</option>
                            <option value="igual" {% if request.GET.prazoValidade_filter == 'igual' %}selected{% endif %}>Igual a</option>
                        </select>
                        <input type="number" name="prazoValidade" placeholder="Dias" value="{{ request.GET.prazoValidade }}">
                    </div>
                </div>
            </div>
            <input type="hidden" name="page" id="page-input-hidden" value="{{ page_obj.number }}">
        </form>

        {% if messages %}
            {% for message in messages %}
                {% if message.level == 40 %}
                    <div class="error-message">{{ message }}</div>
                {% endif %}
            {% endfor %}
        {% endif %}

        <div class="results-table">
            <div class="table-header">
                <div class="col-cod">Código</div>
                <div class="col-desc">Descrição</div>
                <div class="col-dias-vencido">Dias p/ Vencer</div>
                <div class="col-data-vencimento">Data de Vencimento</div>
            </div>

            {% if page_obj.object_list|length == 0 %}
                <div class="no-results">Nenhum material encontrado com os filtros aplicados.</div>
            {% else %}
                {% for material in page_obj %}
                <div class="table-row {% if material.prazoPassadoLinha < 0 %}expired{% endif %}"
                     data-codigo="{{ material.codigo }}"
                     data-descricao="{{ material.descricao }}"
                     data-dias-vencido="{{ material.prazoPassadoLinha }}"
                     data-validade="{{ material.dataValidade }}">
                    <div class="col-cod" data-label="Código:">
                        <span class="material-code">{{ material.codigo }}</span>
                        <svg class='copy-svg' width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                    </div>
                    <div class="col-desc" data-label="Descrição:">{{ material.descricao|truncatechars:100 }}</div>
                    <div class="col-dias-vencido" data-label="Dias p/ Vencer:">
                        {% if material.prazoPassadoLinha < 0 %}
                           Vencido há {{ material.dias_vencido_abs }} dia(s)
                        {% else %}
                            {{ material.prazoPassadoLinha }} dia(s)
                        {% endif %}
                    </div>
                    <div class="col-data-vencimento" data-label="Vencimento:">{{ material.dataValidade }}</div>
                </div>
                {% endfor %}
            {% endif %}
        </div>
        
    {% if page_obj and page_obj.paginator.num_pages > 1 %}
        <nav>
            <ul class="pagination">
                {% if page_obj.has_previous %}
                    <li class="page-item"><a class="page-link" href="?page=1{% if query_string %}&{{ query_string }}{% endif %}">&laquo;&laquo;</a></li>
                    <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if query_string %}&{{ query_string }}{% endif %}">&laquo;</a></li>
                {% endif %}
                <li class="page-item disabled">
                    <span class="page-link">
                        Página
                        <input type="number" min="1" max="{{ page_obj.paginator.num_pages }}" value="{{ page_obj.number }}" id="page-input-direct">
                        de {{ page_obj.paginator.num_pages }}
                    </span>
                </li>
                {% if page_obj.has_next %}
                    <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}{% if query_string %}&{{ query_string }}{% endif %}">&raquo;</a></li>
                    <li class="page-item"><a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if query_string %}&{{ query_string }}{% endif %}">&raquo;&raquo;</a></li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}


    </div>
    
    <div class="modal-overlay hidden" id="product-modal">
        <div class="modal" onclick="(e) => e.stopPropagation()">
            <div class="modal-header">
                <h3>Detalhes do Material</h3>
                <button id="close-modal-btn" aria-label="Fechar modal">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>
                </button>
            </div>
            <div class="modal-divider"></div>
            <div class="modal-content">
                <div class="modal-row">
                    <span>Código:</span>
                    <span id="modal-codigo" class="material-code"></span>
                    <svg class='copy-svg' style="margin-left: 8px;" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                </div>
                <div class="modal-row">
                    <span>Data de Vencimento:</span>
                    <span id="modal-validade" style="margin-left: 20px;"></span>
                </div>
                <div class="modal-row">
                    <span>Dias para Vencer:</span>
                    <span id="modal-dias-vencido" style="margin-left: 20px;"></span>
                </div>
                <div class="modal-row full-width">
                    <span>Descrição Completa:</span>
                    <textarea id="modal-descricao" readOnly></textarea>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- ELEMENTOS DO DOM ---
            const filterForm = document.getElementById('filter-form');
            const clearFiltersBtn = document.getElementById('clear-filters-btn');
            const pageInputDirect = document.getElementById('page-input-direct');
            const modalOverlay = document.getElementById('product-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            
            // --- FUNÇÃO REUTILIZÁVEL PARA ANIMAÇÃO DE CÓPIA ---
            function handleCopyAnimation(clickedElement) {
                const parentDiv = clickedElement.parentElement;
                const codeSpan = parentDiv.querySelector('.material-code');
                if (!codeSpan) return;

                const codeToCopy = codeSpan.innerText.trim();
                navigator.clipboard.writeText(codeToCopy).then(() => {
                    const feedbackMessage = document.createElement('span');
                    feedbackMessage.textContent = 'Copiado! ✓';
                    feedbackMessage.style.color = '#28a745';
                    feedbackMessage.style.fontWeight = 'bold';
                    feedbackMessage.style.fontSize = '0.9em';
                    
                    const copyIcon = parentDiv.querySelector('.copy-svg');
                    
                    codeSpan.style.display = 'none';
                    if (copyIcon) copyIcon.style.display = 'none';
                    parentDiv.insertBefore(feedbackMessage, copyIcon);

                    setTimeout(() => {
                        feedbackMessage.remove();
                        codeSpan.style.display = 'inline';
                        if (copyIcon) copyIcon.style.display = 'inline';
                    }, 2000);
                }).catch(err => console.error('Falha ao copiar:', err));
            }

            // --- MANIPULADORES DE EVENTOS ---
            
            // Limpar filtros
            clearFiltersBtn.addEventListener('click', () => {
                window.location.href = window.location.pathname;
            });

            // Ir para página específica
            pageInputDirect?.addEventListener('change', function (e) {
                const page = e.target.value;
                const urlParams = new URLSearchParams(window.location.search);
                urlParams.set('page', page);
                window.location.search = urlParams.toString();
            });

            // Enviar formulário ao clicar nos ícones de busca
            document.querySelectorAll('.submit-on-click').forEach(icon => {
                icon.addEventListener('click', () => filterForm.submit());
            });

            // Abrir o modal com dados da linha
            document.querySelectorAll('.table-row').forEach(row => {
                row.addEventListener('click', (e) => {
                    if (e.target.closest('.col-cod')) return; // Não abre modal se clicar na área do código
                    
                    // Populando o modal
                    document.getElementById('modal-codigo').textContent = row.dataset.codigo;
                    document.getElementById('modal-validade').textContent = row.dataset.validade;
                    document.getElementById('modal-descricao').value = row.dataset.descricao;

                    const diasVencido = parseInt(row.dataset.diasVencido, 10);
                    const diasEl = document.getElementById('modal-dias-vencido');
                    if (diasVencido < 0) {
                        diasEl.textContent = `Vencido há ${Math.abs(diasVencido)} dia(s)`;
                        diasEl.style.color = '#dc3545';
                    } else {
                        diasEl.textContent = `${diasVencido} dia(s)`;
                        diasEl.style.color = 'inherit';
                    }
                    
                    modalOverlay.classList.remove('hidden');
                });
            });

            // Fechar o modal
            closeModalBtn.addEventListener('click', () => modalOverlay.classList.add('hidden'));
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) modalOverlay.classList.add('hidden');
            });

            // Aplicar função de cópia a todos os ícones de cópia
            document.querySelectorAll('.copy-svg').forEach(icon => {
                icon.addEventListener('click', function (event) {
                    event.stopPropagation();
                    handleCopyAnimation(this);
                });
            });

            // Lógica do menu hambúrguer para mobile
            const menuToggle = document.querySelector('.menu-toggle');
            const nav = document.querySelector('.nav');
            if (menuToggle && nav) {
                menuToggle.addEventListener('click', function () {
                    this.classList.toggle('active');
                    nav.classList.toggle('active');
                });
            }
        });
    </script>
</body>
</html>